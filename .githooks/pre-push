#!/bin/bash
# Pre-push hook for Gartan Scraper Bot
# Runs comprehensive tests and validations before pushing.
# Adds explicit timeouts & robust cleanup to avoid hanging pushes.

set -euo pipefail

DOCKER_BUILD_TIMEOUT=${DOCKER_BUILD_TIMEOUT:-300}   # seconds (5m default)
API_START_TIMEOUT=${API_START_TIMEOUT:-10}

echo "üöÄ Running pre-push checks (timeouts: docker=${DOCKER_BUILD_TIMEOUT}s api=${API_START_TIMEOUT}s)..."

# Ensure cleanup always happens
cleanup() {
    if [[ -n "${server_pid:-}" ]]; then
        kill "$server_pid" 2>/dev/null || true
    fi
}
trap cleanup EXIT INT TERM

# Run all tests including integration tests
echo "üß™ Running comprehensive test suite..."
python -m pytest tests/ -v --cov=. --cov-report=term-missing || {
    echo "‚ùå Comprehensive tests failed"
    exit 1
}

# Check that API server can start
echo "üåê Testing API server startup (timeout ${API_START_TIMEOUT}s)..."
if command -v timeout >/dev/null 2>&1; then
    timeout ${API_START_TIMEOUT}s python api_server.py > logs/prepush_api_start.log 2>&1 &
else
    python api_server.py > logs/prepush_api_start.log 2>&1 &
fi
server_pid=$!
sleep 2

# Test if server is responsive
if curl -f http://localhost:5000/health > /dev/null 2>&1; then
    echo "‚úÖ API server starts successfully"
else
    echo "‚ùå API server failed to start or respond"
    kill $server_pid 2>/dev/null || true
    exit 1
fi

# Stop API server (trap will also catch if earlier fail)
kill $server_pid 2>/dev/null || true

# Check Docker build (if Docker is available)
if command -v docker &> /dev/null; then
    echo "üê≥ Testing Docker build (timeout ${DOCKER_BUILD_TIMEOUT}s)..."
    build_log="logs/prepush_docker_build.log"
    mkdir -p logs
    if command -v timeout >/dev/null 2>&1; then
        if ! timeout ${DOCKER_BUILD_TIMEOUT}s docker build --progress=plain -t gartan-scraper-test . > "$build_log" 2>&1; then
            status=$?
            echo "‚ùå Docker build failed or timed out (exit=$status). Last 40 lines:" >&2
            tail -n 40 "$build_log" || true
            exit 1
        fi
    else
        if ! docker build --progress=plain -t gartan-scraper-test . > "$build_log" 2>&1; then
            status=$?
            echo "‚ùå Docker build failed (exit=$status). Last 40 lines:" >&2
            tail -n 40 "$build_log" || true
            exit 1
        fi
    fi
    echo "‚úÖ Docker build successful"
    docker rmi gartan-scraper-test > /dev/null 2>&1 || true
else
    echo "‚ÑπÔ∏è  Docker not found; skipping image build test"
fi

# Check for large files
echo "üìè Checking for large files..."
large_files=$(git ls-files | xargs ls -l | awk '$5 > 1048576 {print $9, $5}' || true)
if [ -n "$large_files" ]; then
    echo "‚ö†Ô∏è  Warning: Large files detected (>1MB):"
    echo "$large_files"
    echo "Consider using Git LFS for large files"
fi

# Check for secrets in code
echo "üîí Checking for potential secrets..."
secret_patterns=("password" "secret" "token" "api_key")
for pattern in "${secret_patterns[@]}"; do
    matches=$(git diff origin/main --name-only | xargs grep -il "$pattern" 2>/dev/null | grep -v ".env.example" || true)
    if [ -n "$matches" ]; then
        echo "‚ö†Ô∏è  Warning: Potential secrets found in files containing '$pattern':"
        echo "$matches"
        echo "Please review these files to ensure no secrets are committed"
    fi
done

echo "‚úÖ All pre-push checks passed!"
